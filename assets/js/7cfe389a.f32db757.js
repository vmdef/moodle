"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[61361],{78989:function(e,t,a){a.d(t,{W7:function(){return p}});var n,r=a(67294),o=a(46975),i=JSON.parse('{"plugintypes":{"antivirus":"lib/antivirus","availability":"availability/condition","qtype":"question/type","mod":"mod","auth":"auth","calendartype":"calendar/type","customfield":"customfield/field","enrol":"enrol","message":"message/output","block":"blocks","media":"media/player","filter":"filter","editor":"lib/editor","format":"course/format","dataformat":"dataformat","profilefield":"user/profile/field","report":"report","coursereport":"course/report","gradeexport":"grade/export","gradeimport":"grade/import","gradereport":"grade/report","gradingform":"grade/grading/form","mlbackend":"lib/mlbackend","mnetservice":"mnet/service","webservice":"webservice","repository":"repository","portfolio":"portfolio","search":"search/engine","qbank":"question/bank","qbehaviour":"question/behaviour","qformat":"question/format","plagiarism":"plagiarism","tool":"admin/tool","cachestore":"cache/stores","cachelock":"cache/locks","fileconverter":"files/converter","contenttype":"contentbank/contenttype","theme":"theme","local":"local","h5plib":"h5p/h5plib","paygw":"payment/gateway"},"subsystems":{"access":null,"admin":"admin","adminpresets":"admin/presets","analytics":"analytics","antivirus":"lib/antivirus","auth":"auth","availability":"availability","backup":"backup/util/ui","badges":"badges","block":"blocks","blog":"blog","bulkusers":null,"cache":"cache","calendar":"calendar","cohort":"cohort","comment":"comment","competency":"competency","completion":"completion","contentbank":"contentbank","countries":null,"course":"course","courseformat":"course/format","currencies":null,"customfield":"customfield","dbtransfer":null,"debug":null,"editor":"lib/editor","edufields":null,"enrol":"enrol","error":null,"favourites":"favourites","filepicker":null,"fileconverter":"files/converter","files":"files","filters":"filter","form":"lib/form","grades":"grade","grading":"grade/grading","group":"group","help":null,"hub":null,"h5p":"h5p","imscc":null,"install":null,"iso6392":null,"langconfig":null,"license":null,"mathslib":null,"media":"media","message":"message","mimetypes":null,"mnet":"mnet","my":"my","notes":"notes","pagetype":null,"payment":"payment","pix":null,"plagiarism":"plagiarism","plugin":null,"portfolio":"portfolio","privacy":"privacy","question":"question","rating":"rating","reportbuilder":"reportbuilder","repository":"repository","rss":"rss","role":"admin/roles","search":"search","table":"lib/table","tag":"tag","timezones":null,"user":"user","userkey":"lib/userkey","webservice":"webservice","xapi":"lib/xapi"}}'),s=function(e){return function(t){var a=t.plugintype,n=void 0===a?"plugintype":a,r=t.pluginname,o=void 0===r?"pluginname":r,i=t.filepath,s=void 0===i?null:i,l=function(e){return function(t){return e.plugintypes[t]?e.plugintypes[t]:"[path/to/"+t+"]"}}(e)(n);return""+(l+=o?"/"+o:"/[pluginname]")+s}},l=s(i),u=(l(i),function(e){if(!e.showFileHeader)return"";switch(null==e?void 0:e.filetype){case"xml":return"";case"js":case"javascript":return function(e){var t=e.plugintype,a=void 0===t?"plugintype":t,n=e.pluginname,r=void 0===n?"pluginname":n,o=e.examplePurpose,i=e.modulename;if(!o)throw Error("Purpose must be specified");if(!i)throw Error("AMD Module name must be specified");return["/**"," * "+o+" for the "+a+"_"+r+" plugin."," *"," * @module   "+a+"_"+r+"/"+i," * @copyright Year, You Name <your@email.address>"," * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later"," */",""].join("\n")}(e);default:return function(e){var t=e.plugintype,a=void 0===t?"plugintype":t,n=e.pluginname,r=void 0===n?"pluginname":n,o=e.examplePurpose;if(!o)throw Error("Purpose must be specified");return["/**"," * "+o+" for the "+a+"_"+r+" plugin."," *"," * @package   "+a+"_"+r," * @copyright Year, You Name <your@email.address>"," * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later"," */",""].join("\n")}(e)}}),c=function(e){return e.showLicense?(e.filetype,"// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n"):""},d=function(e){var t=e.filetype,a=void 0===t?"php":t;switch(a){case"js":case"javascript":return"javascript";case"xml":return"xml";case"php":case null:return"php";default:return a}},p=(n=i,function(e,t){var a,i=Object.assign({plugintype:"plugintype",showLicense:!0,showFileHeader:!0,filepath:null!=(a=e.exampleFilepath)?a:e.filepath},e),l=s(n),p=function(e,t){void 0===t&&(t=null);var a=[c(e),u(e),e.example?e.example:t||null].filter((function(e){return e})).map((function(e){return e.trim()})).join("\n\n");return[function(e){var t=e.filetype;switch(void 0===t?"php":t){case"js":case"javascript":case"xml":return null;default:return"<?php"}}(e),a].filter((function(e){return e})).join("\n")}(i,t);return r.createElement(o.Z,{title:l(i),language:d(i)},p)})},70118:function(e,t,a){a.r(t),a.d(t,{assets:function(){return m},contentTitle:function(){return d},default:function(){return v},frontMatter:function(){return c},metadata:function(){return p},toc:function(){return b}});var n=a(83117),r=a(80102),o=(a(67294),a(3905)),i=a(13904),s=a(78989),l=a(74936),u=["components"],c={title:"Migrating 3.11 formats",tags:["Plugins","Format"]},d=void 0,p={unversionedId:"apis/plugintypes/format/migration",id:"apis/plugintypes/format/migration",title:"Migrating 3.11 formats",description:"The new course editor introduced n Moodle 4.0 reimplements most of the previous webservices, AMD modules, and internal logic of the course rendering. However, all formats since 3.11 will use the previous libraries by default until its final deprecation in Moodle 4.3. This document collects the main adaptations any 3.11 course format will require to continue working when this happens.",source:"@site/docs/apis/plugintypes/format/migration.md",sourceDirName:"apis/plugintypes/format",slug:"/apis/plugintypes/format/migration",permalink:"/devdocs/docs/apis/plugintypes/format/migration",draft:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/plugintypes/format/migration.md",tags:[{label:"Plugins",permalink:"/devdocs/docs/tags/plugins"},{label:"Format",permalink:"/devdocs/docs/tags/format"}],version:"current",lastUpdatedBy:"Andrew Lyons",lastUpdatedAt:1655463803,formattedLastUpdatedAt:"17/06/2022",frontMatter:{title:"Migrating 3.11 formats",tags:["Plugins","Format"]},sidebar:"docs",previous:{title:"Course format",permalink:"/devdocs/docs/apis/plugintypes/format/"},next:{title:"Local plugins",permalink:"/devdocs/docs/apis/plugintypes/local/"}},m={},h={examplePurpose:"Output renderer",plugintype:"format",pluginname:"pluginname",filepath:"/output/renderer.php"},f={examplePurpose:"Format course display",plugintype:"format",pluginname:"pluginname",filepath:"/format.php"},g={examplePurpose:"Format base class with course index enabled",plugintype:"format",pluginname:"pluginname",filepath:"/lib.php"},k={examplePurpose:"Format base class with components enabled",plugintype:"format",pluginname:"pluginname",filepath:"/lib.php"},b=[{value:"Changes summary",id:"changes-summary",level:2},{value:"Moodle 3.11 vs 4.0 course editor architecture",id:"moodle-311-vs-40-course-editor-architecture",level:2},{value:"First steps to migrate a 3.11 course format to 4.0",id:"first-steps-to-migrate-a-311-course-format-to-40",level:2},{value:"Point 1: create a renderer class",id:"point-1-create-a-renderer-class",level:3},{value:"Point 2: fix your base class",id:"point-2-fix-your-base-class",level:3},{value:"The new output architecture",id:"the-new-output-architecture",level:2},{value:"Migrating old renderer methods to outputs",id:"migrating-old-renderer-methods-to-outputs",level:2},{value:"Step 1: start using output components and renderers",id:"step-1-start-using-output-components-and-renderers",level:3},{value:"Step 2: override any output class to alter the template data to your plugin needs",id:"step-2-override-any-output-class-to-alter-the-template-data-to-your-plugin-needs",level:3},{value:"Step 3: create the basic mustache structure",id:"step-3-create-the-basic-mustache-structure",level:3},{value:"Step 4: create your own custom mustache blocks",id:"step-4-create-your-own-custom-mustache-blocks",level:3},{value:"Enabling course index in your format",id:"enabling-course-index-in-your-format",level:2},{value:"Enabling reactive components",id:"enabling-reactive-components",level:2},{value:"Step 2: enable supports components feature",id:"step-2-enable-supports-components-feature",level:3},{value:"Step 3: check the reactive components are enabled.",id:"step-3-check-the-reactive-components-are-enabled",level:3}],y={toc:b};function v(e){var t=e.components,d=(0,r.Z)(e,u);return(0,o.kt)("wrapper",(0,n.Z)({},y,d,{components:t,mdxType:"MDXLayout"}),(0,o.kt)(i.Z,(0,n.Z)({frontMatter:c},void 0!==p?{metadata:p}:{},{mdxType:"MoodlePageBanner"})),(0,o.kt)("p",null,"The new course editor introduced n Moodle 4.0 reimplements most of the previous webservices, AMD modules, and internal logic of the course rendering. However, all formats since 3.11 will use the previous libraries by default until its final deprecation in Moodle 4.3. This document collects the main adaptations any 3.11 course format will require to continue working when this happens."),(0,o.kt)("h2",{id:"changes-summary"},"Changes summary"),(0,o.kt)("p",null,"The main areas affected by the new 4.0 course editor are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Course format plugins are now part of the ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat")," subsystem"),(0,o.kt)("li",{parentName:"ul"},"The old format_base class is now ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat\\base")," and it is mandatory for all format plugins to extend."),(0,o.kt)("li",{parentName:"ul"},"Format plugin renderer is now mandatory (and in most cases they will extend ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat\\output\\section_renderer"),")"),(0,o.kt)("li",{parentName:"ul"},"The old format_section_renderer_base is now ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat\\output\\section_renderer")),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat\\output\\section_renderer")," class now it extends core_course_renderer directly. This means that ",(0,o.kt)("inlineCode",{parentName:"li"},"$this->courserenderer")," attribute is deprecated."),(0,o.kt)("li",{parentName:"ul"},"All renderer methods using html_writer are deprecated. All UI elements are now rendered using output classes and mustache files. Formats can provide alternative output classes and templates."),(0,o.kt)("li",{parentName:"ul"},"The new editor uses data attributes instead of CSS classes to locate section and activities elements in the page HTML. All elements must add those attributes to use the new AMD modules."),(0,o.kt)("li",{parentName:"ul"},"Most of the logic of the previous core_course/actions AMD module is now replaced with core_courseformat AMD modules, each one corresponding to the specific UI elements."),(0,o.kt)("li",{parentName:"ul"},"Formats can override the ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat\\base::uses_course_index")," in their base class to enable the course index."),(0,o.kt)("li",{parentName:"ul"},"Formats can override the ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat\\base::supports_components")," in their base class to use the new course editor library instead of the legacy one."),(0,o.kt)("li",{parentName:"ul"},"The course frontend uses a reactive state to maintain the UI elements updated. Format plugins can create new reactive AMD modules to interact with that state or extend the core_courseformat state classes to extend the data stored in that state."),(0,o.kt)("li",{parentName:"ul"},"Course formats now can implement the ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat\\base::delete_format_data"),"  hook to clean data when the course is deleted."),(0,o.kt)("li",{parentName:"ul"},"The course ",(0,o.kt)("inlineCode",{parentName:"li"},"format_base")," class now provides a method ",(0,o.kt)("inlineCode",{parentName:"li"},"show_editor")," to know if the user is editing or not the course depending on the page editing and the user capabilities. This method should be used instead of the previous ",(0,o.kt)("inlineCode",{parentName:"li"},"$PAGE->user_is_editing() && has_capability('moodle/course:update', $coursecontext)"),".")),(0,o.kt)("h2",{id:"moodle-311-vs-40-course-editor-architecture"},"Moodle 3.11 vs 4.0 course editor architecture"),(0,o.kt)("p",null,"The 4.0 course editor follows a completely new pattern that is not compatible with the previous one. That new pattern is called ",(0,o.kt)("strong",{parentName:"p"},"reactive components"),"."),(0,o.kt)("p",null,"To ensure all 3.11 formats are still usable in 4.0 the new architecture is opt-in, meaning that in order to use the new libraries old formats must indicate to the system that they are compatible (overriding the ",(0,o.kt)("inlineCode",{parentName:"p"},"core_courseformat\\base::supports_components"),")."),(0,o.kt)("p",null,"The following table compares some of the main changes:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Moodle 3.11"),(0,o.kt)("th",{parentName:"tr",align:null},"Moodle 4.0"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},'AMD module "core_course/actions" is responsible for capturing the course edition actions, sending them to the correct course webservice, and replacing the returned HTML into the proper page elements.'),(0,o.kt)("td",{parentName:"tr",align:null},"Al the functionalities from the original actions are now divided into several AMD modules:",(0,o.kt)("ul",null,(0,o.kt)("li",null,'core_courseformat/local/courseeditor: coordinates all the UI elements via a data structure called "reactive state data" (or simply, "state data").'),(0,o.kt)("li",null,"core_courseformat/local/courseeditor/mutations: centralizes all the backend calls and applies the results to the reactive state data before the UI components update the interface."),(0,o.kt)("li",null,"core_courseformat/local/content/actions: captures the user clicks on specific action links and displays modals to get more information from the user if necessary (for example the destination position in a move activity action)."),(0,o.kt)("li",null,"core_courseformat/content/","*",": ADM modules responsible for keeping some part of the UI aligned with the reactive state data."),(0,o.kt)("li",null,"core_courseformat/courseeditor/","*",": other modules and helpers")),(0,o.kt)("p",null,"NOTE: some user actions like hiding and showing sections/activities are not yet migrated to the new architecture."),(0,o.kt)("p",null,"NOTE: updating a full section or activity HTML is still handled by the core_course/actions module. However, now both methods are public to the module and they are used by the new course editor."))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"course/dndupload.js file is responsible for handling any file dropping on the course page."),(0,o.kt)("td",{parentName:"tr",align:null},"Moodle 4.0 still uses the course/dndupload.js to handle files dropped into the course area.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"The webservice core_course_edit_section is responsible for updating a course section and returning the section header and the activities list HTML."),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("p",null,"Except for showing and hiding a section (not migrated yet) the rest of the section actions are now handled by the new ",(0,o.kt)("inlineCode",{parentName:"td"},"core_courseformat_update_course")," webservice."),(0,o.kt)("p",null,"The new webservice has the same parameters for both section and activity actions and always returns a standardized data structure to interact with the frontend reactive state data. This means that it does not return HTML fragments anymore."))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"The webservice core_course_edit_module is responsible for updating activity and returning the activity HTML or other page fragments."),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("p",null,"Except for showing and hiding an activity (not migrated yet) the rest of the activity actions are now handled by the new ",(0,o.kt)("inlineCode",{parentName:"td"},"core_courseformat_update_course")," webservice."),(0,o.kt)("p",null,"The new webservice has the same parameters for both section and activity actions and always returns a standardized data structure to interact with the frontend reactive state data. This means that it does not return HTML fragments anymore."))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"All frontend JS logic is responsible for interacting with the backend and updating all the necessary frontend elements depending on the return value."),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("p",null,'The JS logic is now distributed into several modules called "components". Each module can only interact with a specific page element and watch a data structure called reactive state date (or simply "state data").'),(0,o.kt)("p",null,"The main points of the new component structure are:"),(0,o.kt)("ol",null,(0,o.kt)("li",null,"The initial state data is loaded using the ",(0,o.kt)("inlineCode",{parentName:"td"},"core_courseformat_get_state")," webservice"),(0,o.kt)("li",null,"All components are registered into the core_courseformat/courseeditor page instance."),(0,o.kt)("li",null,"When the state data changes, the course editor instance triggers the component's watchers methods to update the UI."),(0,o.kt)("li",null,"Components are not able to alter the state data. If a component captures an action that requires some state change, it asks the course editor to perform a state mutation.")))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Formats can alter the page HTML by overriding format_section_renderer_base methods"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("p",null,"Most renderer methods are now deprecated and have been migrated to output classes and mustache templates. There are only a few rendered methods formats that can override."),(0,o.kt)("p",null,"Now format plugins can override output classes by simply creating the equivalent format_pluginname/output/courseformat/* class. For example, core_courseformat\\output\\local\\content can be overridden by creating a format_pluginname\\output\\courseformat\\content class."),(0,o.kt)("p",null,'Important note: the new mustache structure uses partials and blocks to include sub-templates. This opens the door to a future frontend course rendering but it also makes the template overriding a bit more complex. See the "overriding templates" section for more information.'))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("p",null,"Format renderer is optional. If none is provided the course format renderer_base is used."),(0,o.kt)("p",null,"Inside a format rendered the ",(0,o.kt)("inlineCode",{parentName:"td"},"$this->courserenderer")," attribute is used to access the course renderer methods.")),(0,o.kt)("td",{parentName:"tr",align:null},"Format renderer is mandatory. The base core_courseformat\\output\\section_renderer now extends the core_course_renderer class and ",(0,o.kt)("inlineCode",{parentName:"td"},"$this->courserenderer")," is deprecated.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},'The page elements are located using css class names such as "li.activity", ".actions", or "li.section".'),(0,o.kt)("td",{parentName:"tr",align:null},"All page elements are now located using data attributes. See ",(0,o.kt)("a",{parentName:"td",href:"../format#course-elements-data-attributes"},"Course elements data attributes")," for more information.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"The course is rendered using print_single_section_page or print_multiple_section_page depending on the number of sections to render."),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("p",null,"The course format base instance contains all the necessary data to determine the way a course is rendered. To Specify a single section page formats should use ",(0,o.kt)("inlineCode",{parentName:"td"},"$format->set_section_number")," method before rendering the course."),(0,o.kt)("p",null,"Once the format instance setup is finished, the course is rendered using the ",(0,o.kt)("inlineCode",{parentName:"td"},"content")," output class. See migrating old renderer methods to outputs section for more information."))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"To know if the user is editing the course, the format should check for ",(0,o.kt)("inlineCode",{parentName:"td"},"$PAGE->user_is_editing()")," to know if edit is enabled and also ",(0,o.kt)("inlineCode",{parentName:"td"},"has_capability('moodle/course:update', $coursecontext)")," to know if the user has the required capabilities."),(0,o.kt)("td",{parentName:"tr",align:null},"The format base class have a method ",(0,o.kt)("inlineCode",{parentName:"td"},"$format->show_editor()")," that do all the user and page validations to know if the current course display has to include editor options or not.")))),(0,o.kt)("p",null,"The following diagram represents the data flow of the new architecture:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Course editor workflow",src:a(6719).Z,width:"1024",height:"768"})),(0,o.kt)("h2",{id:"first-steps-to-migrate-a-311-course-format-to-40"},"First steps to migrate a 3.11 course format to 4.0"),(0,o.kt)("p",null,"From 4.0 the course/format folder has its own subsystem called core_courseformat. This subsystem contains all the course rendering logic (only some minor elements are still in the original location for retro compatibility until Moodle 4.3)."),(0,o.kt)("p",null,"To ensure your format plugin is integrated with the new subsystem:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The main format_pluginname class should extend ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat\\base")," instead of the old format_base one."),(0,o.kt)("li",{parentName:"ul"},"Your plugin ",(0,o.kt)("strong",{parentName:"li"},"must provide a renderer class"),". In most cases this class ",(0,o.kt)("strong",{parentName:"li"},"will extend ",(0,o.kt)("inlineCode",{parentName:"strong"},"core_courseformat\\output\\section_renderer")),"."),(0,o.kt)("li",{parentName:"ul"},"Any output class your plugin needs to override should be located in format_pluginname/classes/output/courseformat")),(0,o.kt)("p",null,"In summary, the first two things you need to adapt to your format are:"),(0,o.kt)("h3",{id:"point-1-create-a-renderer-class"},"Point 1: create a renderer class"),(0,o.kt)("p",null,"Now renderer classes are mandatory for course format plugins. Here there are two scenarios:"),(0,o.kt)("p",null,'Scenario 1: if you plugin already has one you should replace the old "extends format_section_renderer_base" by "extends core_courseformat\\output\\section_renderer".'),(0,o.kt)("p",null,"Scenario 2: If your plugin does not have a renderer, create a file ",(0,o.kt)("strong",{parentName:"p"},"course/format/pluginname/classes/output/renderer.php")," with a content like:"),(0,o.kt)("details",null,(0,o.kt)("summary",null,"View example"),(0,o.kt)("div",null,(0,o.kt)("div",null,(0,s.W7)(h,"\nnamespace format_pluginname\\output;\n\nuse core_courseformat\\output\\section_renderer;\nuse moodle_page;\n\nclass renderer extends section_renderer {\n    // Your renderer methods goes here.\n}\n")))),(0,o.kt)("h3",{id:"point-2-fix-your-base-class"},"Point 2: fix your base class"),(0,o.kt)("p",null,"All Moodle 3.11 formats have a base format class extending format_base class from core_course. In Moodle 4.0 this class has been moved to ",(0,o.kt)("inlineCode",{parentName:"p"},"core_courseformat\\base"),". This means that you should replace the existing extends to avoid the deprecation message."),(0,o.kt)("p",null,'For compatibility reasons, the base class does not use a namespace and should be located in your plugin "lib.php" file. This could change after Moodle 4.3 when most old course rendering methods will be removed from core.'),(0,o.kt)("h2",{id:"the-new-output-architecture"},"The new output architecture"),(0,o.kt)("p",null,"When the debug messages are enabled, all 3.11 format plugins will show several deprecation messages. Most of them are due to the fact that almost all previous renderer methods are now deprecated. The full list can be found in the ",(0,o.kt)("strong",{parentName:"p"},"course/upgrade.txt")," file."),(0,o.kt)("p",null,"Until 3.11 all course page elements are rendered using html_writer inside renderer methods. This made the UI hard to maintain because most of the methods are referring to the standard course structure (section_right_content, section_left_content, start_section_list, end_section_list\u2026) instead of generic concepts like sections, activities, or activity menu."),(0,o.kt)("p",null,"With the new architecture, almost all UI elements are rendered using:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"An ",(0,o.kt)("strong",{parentName:"li"},"output class")," that generates the data to render. For example, course/format/classes/output/local/content/section.php"),(0,o.kt)("li",{parentName:"ul"},"A ",(0,o.kt)("strong",{parentName:"li"},"mustache template")," to render output class data. For example, course/format/templates/local/content/section.mustache"),(0,o.kt)("li",{parentName:"ul"},"An optional ",(0,o.kt)("strong",{parentName:"li"},"reactive component")," to update the frontend when the reactive state data changes: For example, course/format/amd/src/local/content/section.js")),(0,o.kt)("p",null,"The following diagram represents the new output structure compared to the 3.11 one:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Output classes structure",src:a(84539).Z,width:"1964",height:"1427"})),(0,o.kt)("h2",{id:"migrating-old-renderer-methods-to-outputs"},"Migrating old renderer methods to outputs"),(0,o.kt)("p",null,"The process of migrating a renderer method to output can be complex depending on the element your format overrides. For these reasons, Moodle 3.11 formats will remain using the old renderer methods until they explicitly use the new outputs."),(0,o.kt)("h3",{id:"step-1-start-using-output-components-and-renderers"},"Step 1: start using output components and renderers"),(0,o.kt)("p",null,'As in Moodle 3.11 formats, all the course view is initialized and rendered in the "course/format/pluginname/format.php" file. However, the way the outputs are initialized is quite different from the previous version.'),(0,o.kt)("p",null,"In Moodle 3.11 the format.php process was something like:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Do some param validations"),(0,o.kt)("li",{parentName:"ol"},"Get the course format instance using ",(0,o.kt)("inlineCode",{parentName:"li"},"course_get_format")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"core_courseformat\\base::instance")),(0,o.kt)("li",{parentName:"ol"},"Get the format/course renderer using: ",(0,o.kt)("inlineCode",{parentName:"li"},"$PAGE->get_renderer('format_pluginname')"),";"),(0,o.kt)("li",{parentName:"ol"},"Use the renderer ",(0,o.kt)("inlineCode",{parentName:"li"},"print_single_section_page")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"print_multiple_section_page")," depending on the section param.")),(0,o.kt)("p",null,"The problems with that approach were:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"There are two main renderer methods which are almost the same"),(0,o.kt)("li",{parentName:"ul"},"The auxiliary renderer methods require a big amount of params even if they are not needed for the method because they need to provide those parameters to all the child methods.")),(0,o.kt)("p",null,"To avoid this situation now the format base class instance is used as a single exchange param to all output classes. Once the format instance is initialized every output class can get all necessary information from it."),(0,o.kt)("p",null,"The new workflow in 4.0 is:"),(0,o.kt)("details",null,(0,o.kt)("summary",null,"View example"),(0,o.kt)("div",null,(0,o.kt)("div",null,(0,s.W7)(f,l.Z)))),(0,o.kt)("p",null,"Some important notes about the code:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The rendered class now can be obtained using ",(0,o.kt)("inlineCode",{parentName:"li"},"$format->get_renderer")),(0,o.kt)("li",{parentName:"ul"},"Format plugins can override any core_courseformat output class (see sections below for more details). To get the correct output you need to use ",(0,o.kt)("inlineCode",{parentName:"li"},"$format->get_output_classname")," method."),(0,o.kt)("li",{parentName:"ul"},"As you may notice, the output class is rendered directly using the render method, not the ",(0,o.kt)("inlineCode",{parentName:"li"},"render_from_template")," one. This is possible because all output classes implement the new Moodle 4.0 ",(0,o.kt)("inlineCode",{parentName:"li"},"named_templatable")," interface.")),(0,o.kt)("h3",{id:"step-2-override-any-output-class-to-alter-the-template-data-to-your-plugin-needs"},"Step 2: override any output class to alter the template data to your plugin needs"),(0,o.kt)("p",null,"Instead of having several renderer methods on a single file, the core_courseformat subsystem splits the output logic through several small classes, each one for a specific UI component. Format plugins can easily override specific classes to alter the template data."),(0,o.kt)("p",null,"The course format base class has a special method called get_output_classname that returns the overridden class name if available in the format plugin, or the core one if not. In order to detect the format classes, your plugin must place the overridden one in your format_pluginname\\output\\courseformat",".",".."),(0,o.kt)("p",null,'For example, if a format plugin wants to add new options to the section action menu it should override the core_courseformat\\output\\local\\content\\section\\controlmenu. To do so the plugin class should be format_topics\\output\\courseformat\\content\\section\\controlmenu. You can find an example of an overridden output in the "course/format/topics/classes/output/courseformat/content/section/controlmenu.php" file.'),(0,o.kt)("h3",{id:"step-3-create-the-basic-mustache-structure"},"Step 3: create the basic mustache structure"),(0,o.kt)("p",null,"Unlike output classes, mustache files cannot be extended nor overridden. To be able to alter specific mustaches your plugin must provide a minimum template structure. Furthermore, your plugin must provide some overridden output classes providing the alternative mustache templates location."),(0,o.kt)("p",null,"In moodle 3.11 the course render uses html_writer to generate the course view, where each renderer method has both data collection and HTML generating inside. This is not the case in Moodle 4.0. From now on, the full output data is collected via output classes before rendering all the nested mustache templates."),(0,o.kt)("p",null,"The course format subsystem requires a minimum of 3 mustaches to render a course:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"local/content"),": the full course template"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"local/content/section"),": a section template. Used to refresh a section via ajax"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"local/content/section/cmitem"),": an activity item template: Used to refresh an activity via ajax")),(0,o.kt)("p",null,"The first thing your plugin needs is to create that structure and link it to the output components. Follow the guide on the ",(0,o.kt)("a",{parentName:"p",href:"../format#creating-the-basic-output-structure"},"create format plugin page")," to know how to create the basic structure."),(0,o.kt)("h3",{id:"step-4-create-your-own-custom-mustache-blocks"},"Step 4: create your own custom mustache blocks"),(0,o.kt)("p",null,"Once your plugin has the basic mustache structure, you can provide extra mustache blocks to override parts of the page. Follow the ",(0,o.kt)("a",{parentName:"p",href:"../format#override-mustache-blocks"},"Override mustache blocks")," on the Creating a course format page to know how to do it."),(0,o.kt)("h2",{id:"enabling-course-index-in-your-format"},"Enabling course index in your format"),(0,o.kt)("p",null,"If your course format plugin uses a sections-activity structure it is possible to enable the course index. Add the course index in your format is as easy as overriding a method on your format base class:"),(0,o.kt)("details",null,(0,o.kt)("summary",null,"View example"),(0,o.kt)("div",null,(0,o.kt)("div",null,(0,s.W7)(g,"class format_PLUGINNAME extends core_courseformat\\base {\n\n    // More methods can be added here.\n\n    public function uses_course_index() {\n        return true;\n    }\n}\n")))),(0,o.kt)("p",null,"It is important to note that the course index drawer is only available in Boost based themes, Classic based themes won't display it."),(0,o.kt)("p",null,"See the course index section in the create format plugin page for more information."),(0,o.kt)("h2",{id:"enabling-reactive-components"},"Enabling reactive components"),(0,o.kt)("p",null,"Moodle 4.0 introduced a new reactive course editor for the frontend. However, the new modules are not compatible with the previous YUI ones. To prevent errors in the 3.11 formats the new libraries are opt-in, meaning plugins must adapt their code before using it."),(0,o.kt)("p",null,"Step 1: add data attributes to the HTML elements\nThe previous YUI editor uses CSS classes to identify sections, activities, and section headers. Nowadays, the use of CSS classes beyond styling is discouraged so the new library uses data attributes to identify the main course page elements."),(0,o.kt)("p",null,"To adapt your plugin to the new editor you must add the proper data attributes. The following table explains the new selectors:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Concept"),(0,o.kt)("th",{parentName:"tr",align:null},"3.11 equivalent"),(0,o.kt)("th",{parentName:"tr",align:null},"4.0 data attributes"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Section"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"li.section#section-{SECTION.NUM}")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'data-for="section"'),(0,o.kt)("br",null),(0,o.kt)("inlineCode",{parentName:"td"},"data-id={SECTION.ID}"),(0,o.kt)("br",null),(0,o.kt)("inlineCode",{parentName:"td"},"data-number={SECTION.NUM}"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Section header"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"#sectionid-{SECTION.ID}-title")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'data-for="section_title"'),(0,o.kt)("br",null),(0,o.kt)("inlineCode",{parentName:"td"},"data-id={SECTION.ID}"),(0,o.kt)("br",null),(0,o.kt)("inlineCode",{parentName:"td"},"data-number={SECTION.NUM}"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Course module item (activity)"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"li.activity#module-{CM.ID}")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'data-for="cmitem"'),(0,o.kt)("br",null),(0,o.kt)("inlineCode",{parentName:"td"},"data-id={CM.ID}"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Course sections list"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},".course-content>ul")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'data-for="course_sectionlist"'),(0,o.kt)("br",null))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Course module action link"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"a.cm-edit-action")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"data-action={ACTIONNAME}"),(0,o.kt)("br",null),(0,o.kt)("inlineCode",{parentName:"td"},"data-id={CM.ID}"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Section action link"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},".section_action_menu")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"data-action={ACTIONNAME}"),(0,o.kt)("br",null),(0,o.kt)("inlineCode",{parentName:"td"},"data-id={SECTION.ID}"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Section info"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},".section_availability")),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'data-for="sectioninfo"'))))),(0,o.kt)("h3",{id:"step-2-enable-supports-components-feature"},"Step 2: enable supports components feature"),(0,o.kt)("p",null,"Once your plugin has all the necessary data attributes you can disable the old YUI editor and enable the new reactive one by adding this method to your plugin base class:"),(0,o.kt)("details",null,(0,o.kt)("summary",null,"View example"),(0,o.kt)("div",null,(0,o.kt)("div",null,(0,s.W7)(k,"class format_PLUGINNAME extends core_courseformat\\base {\n\n    // More methods can be added here.\n\n    public function supports_components() {\n        return true;\n    }\n}\n")))),(0,o.kt)("h3",{id:"step-3-check-the-reactive-components-are-enabled"},"Step 3: check the reactive components are enabled."),(0,o.kt)("p",null,"In principle, if you create the basic mustache structure as described in the previous chapter the course editor should work as expected. However, to check if they are working properly:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Enable developer debug level on your site and access a course as an administrator"),(0,o.kt)("li",{parentName:"ol"},'Wait for the page to load and find in the debug footer the "Reactive instances" section.'),(0,o.kt)("li",{parentName:"ol"},'Click on the button "CourseEditorXXXX" (where XXXX is the current course ID)'),(0,o.kt)("li",{parentName:"ol"},'Once the panel opens, click on the "Highlight OFF" button (it will change to "Highlight ON")'),(0,o.kt)("li",{parentName:"ol"},"Go to the top of the page and check the course content has several thick blue borders.")),(0,o.kt)("p",null,"If the border appears around all the course content elements (sections, section headers and activities) means that the course editor has registered all the course content as a reactive component."),(0,o.kt)("p",null,"If you don't have a \"CourseEditorXXXX\" button or the content elements don't get highlighted means that, most probably, you override the main content mustache in a peculiar way and removed the JS initialization."),(0,o.kt)("p",null,'To re-introduce the JS initialization you should edit the plugin\'s "content.mustache" file with the following:'),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Add ",(0,o.kt)("inlineCode",{parentName:"li"},'id="{{uniqid}}-course-format"')," to the course content div element."),(0,o.kt)("li",{parentName:"ul"},"At the end of the template add:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-handlebars"},"{{#js}}\nrequire(['core_courseformat/local/content'], function(component) {\n    component.init('{{uniqid}}-course-format', {}, {{sectionreturn}});\n});\n{{/js}}\n")),(0,o.kt)("p",null,"By doing that the content main reactive component should be initialized and if you enable the highlighting the content should have a blue border. If some if the inner elements does not have a blue border when highlight is ON means that some data attribute is missing. Check the step 1 of this chapter for more information."))}v.isMDXComponent=!0},74936:function(e,t){t.Z="defined('MOODLE_INTERNAL') || die();\n\nrequire_once($CFG->libdir . '/filelib.php');\nrequire_once($CFG->libdir . '/completionlib.php');\n\n// Retrieve course format option fields and add them to the $course object.\n$format = core_courseformat\\base::instance($course);\n$course = $format->get_course();\n$context = context_course::instance($course->id);\n\n// Add any extra logic here.\n\n// Make sure section 0 is created.\ncourse_create_sections_if_missing($course, 0);\n\n$renderer = $format->get_renderer($PAGE);\n\n// Setup the format base instance.\nif (!empty($displaysection)) {\n$format->set_section_number($displaysection);\n}\n// Output course content.\n$outputclass = $format->get_output_classname('content');\n$widget = new $outputclass($format);\necho $renderer->render($widget);\n\n// Include any format js module here using $PAGE->requires->js.\n"},6719:function(e,t,a){t.Z=a.p+"assets/images/course_editor_workflow-ed9299531897af09aabc760f3d3a3ae5.png"},84539:function(e,t,a){t.Z=a.p+"assets/images/course_format_output-cc6218fac14403f9fcffdcb1eef001ec.png"}}]);