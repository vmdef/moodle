define ("local_plugins/browser-grid",["jquery","core/log","core/ajax","core/templates"],function(a,b,c,d){'use strict';function e(c){var d=this;d.grid=c.find("[data-widget=\"browser-grid\"]").first();if(!d.grid.length){b.error("Grid wrapper widget not found");return}f(d.grid,"data-lazyload");d.displayShowMoreWidget();d.grid.on("click","article",function(b){var c=a(this);if(!a(b.target).is("[data-widget=\"directlink\"]")){b.preventDefault();d.previewPlugin(c)}});a(window).on("popstate",function(a){if(null!==a.originalEvent.state&&"undefined"!=typeof a.originalEvent.state.query){location.reload()}})}e.prototype.previewPlugin=function(c){var e=JSON.parse(c.attr("data-rawinfo"));if(!e){b.error("Unable to access plugin raw info");return a.Deferred().reject("Unable to access plugin raw info")}return d.render("local_plugins/browser_grid_preview",e).fail(function(a){b.error("Unable to render preview:"+a)}).then(function(b){var d=a(b);c.after(d);return d}).then(function(b){b.modal("show");b.find("[data-widget=\"close\"]").on("click",function(a){a.preventDefault();b.modal("hide")});if(0<e.screenshots.length){var c=[e.mainscreenshot.bigthumb],d=0;e.screenshots.forEach(function(b){c.push(b.bigthumb);a("<img/>")[0].src=b.bigthumb});b.find("[data-region=\"preview-screenshot\"]").on("click",function(b){b.preventDefault();var e=a(b.currentTarget);d++;if(d>=c.length){d=0}e.attr("src",c[d])})}a(window).on("keyup",function(a){if(27===a.keyCode){b.modal("hide")}});a(window).on("click",function(a){if(a.target==b[0]){a.preventDefault();b.modal("hide")}})})};e.prototype.search=function(d){var e=this;d=d.trim();if(e.grid.attr("data-query")===d){return a.Deferred().resolve()}return c.call([{methodname:"local_plugins_get_plugins_batch",args:{query:d,batch:0}}])[0].fail(function(a){b.error("Unable to get plugins batch: "+a)}).then(function(a){e.grid.attr("data-query",a.grid.query);history.pushState({query:a.grid.query},"","/plugins/?q="+a.grid.query);return e.replace(a)})};e.prototype.displayShowMoreWidget=function(){var b=this,c=parseInt(b.grid.attr("data-batchsize"));if(b.grid.find("[data-widget=\"plugincard\"]").length<c){return}b.showMoreWidget=a("<a href=\"\" class=\"btn btn-primary btn-lg\"><i class=\"fa fa-forward\" aria-hidden=\"true\"></i> Show more </a>");b.showMoreWidget.on("click",function(a){a.preventDefault();b.showMore()});b.grid.find("[data-region=\"loadmore\"]").html(b.showMoreWidget)};e.prototype.showMore=function(){var a=this,d=a.grid.attr("data-query"),e=parseInt(a.grid.attr("data-batch"))+1;b.debug(d);b.debug(e);return c.call([{methodname:"local_plugins_get_plugins_batch",args:{query:d,batch:e}}])[0].fail(function(a){b.error("Unable to get plugins batch: "+a)}).then(function(b){return a.append(b)})};e.prototype.replace=function(a){var c=this;c.processResponse(a);return d.render("local_plugins/browser_grid",a.grid).fail(function(a){b.error("Unable to render returned response:"+a)}).then(function(b){c.grid.html(b);c.displayShowMoreWidget();return a}).then(function(){return f(c.grid,"data-lazyload")})};e.prototype.append=function(c){var e=this;e.processResponse(c);if(0===c.grid.plugins.length){e.showMoreWidget.remove();return a.Deferred().resolve()}return d.render("local_plugins/browser_grid_batch",c.grid).fail(function(a){b.error("Unable to render returned response:"+a)}).then(function(a){e.grid.find("[data-region=\"loadmore\"]").before(a);return c}).then(function(){return f(e.grid,"data-lazyload")})};e.prototype.processResponse=function(a){var b=this;b.grid.attr("data-batch",a.grid.batch);b.grid.attr("data-batchsize",a.grid.batchsize);a.grid.plugins.forEach(function(a){a.rawinfo=JSON.stringify(a)})};function f(b,c){var d=a.Deferred(),e=b.find("["+c+"]");if(e.length){e.each(function(){var e=a(this),f=e.attr(c);if(f){e.attr("src",f)}e.removeAttr(c);if(0===b.find("["+c+"]").length){e.on("load",d.resolve)}})}else{d.resolve()}return d}return{init:function init(a){return new e(a)}}});
//# sourceMappingURL=browser-grid.min.js.map
