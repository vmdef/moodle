{"version":3,"sources":["../src/browser-grid.js"],"names":["define","$","Log","Ajax","Templates","BrowserGrid","region","self","grid","find","first","length","error","imgSrcLazyLoad","displayShowMoreWidget","on","e","article","target","is","preventDefault","previewPlugin","window","originalEvent","state","query","location","reload","prototype","rawinfo","JSON","parse","attr","Deferred","reject","render","fail","reason","then","html","preview","after","modal","screenshots","screenshoturls","mainscreenshot","bigthumb","screenshotindex","forEach","s","push","src","img","currentTarget","keyCode","search","trim","resolve","call","methodname","args","batch","response","history","pushState","replace","batchsize","parseInt","showMoreWidget","showMore","nextbatch","debug","append","processResponse","plugins","remove","before","data","stringify","root","sourceHolder","promise","imgs","each","removeAttr","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Controls the display of browser plugins in a grid.\n *\n * @module      local_plugins/browser-grid\n * @package     local_plugins\n * @subpackage  amd\n * @category    output\n * @copyright   2016 David Mudr√°k <david@moodle.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n        'jquery',\n        'core/log',\n        'core/ajax',\n        'core/templates',\n],\nfunction($, Log, Ajax, Templates) {\n    'use strict';\n\n    /**\n     * Represents the grid of plugins displayed on the screen.\n     *\n     * @constructor\n     * @param {jQuery} region\n     */\n    function BrowserGrid(region) {\n        var self = this;\n\n        self.grid = region.find('[data-widget=\"browser-grid\"]').first();\n\n        if (!self.grid.length) {\n            Log.error('Grid wrapper widget not found');\n            return;\n        }\n\n        imgSrcLazyLoad(self.grid, 'data-lazyload');\n\n        self.displayShowMoreWidget();\n\n        self.grid.on('click', 'article', /** @this HTMLElement */  function (e) {\n            var article = $(this);\n\n            if (! $(e.target).is('[data-widget=\"directlink\"]')) {\n                e.preventDefault();\n                self.previewPlugin(article);\n            }\n        });\n\n        $(window).on('popstate', function (e) {\n            if ((e.originalEvent.state !== null) && typeof e.originalEvent.state.query !== 'undefined') {\n                location.reload();\n            }\n        });\n    }\n\n    /**\n     * Display a modal preview of the plugin in the given article card.\n     *\n     * @method\n     * @param {jQuery} article\n     * @return {Deferred}\n     */\n    BrowserGrid.prototype.previewPlugin = function (article) {\n\n        var rawinfo = JSON.parse(article.attr('data-rawinfo'));\n\n        if (!rawinfo) {\n            Log.error('Unable to access plugin raw info');\n            return $.Deferred().reject('Unable to access plugin raw info');\n        }\n\n        return Templates.render('local_plugins/browser_grid_preview', rawinfo).fail(function(reason) {\n            Log.error('Unable to render preview:' + reason);\n\n        }).then(function(html) {\n            var preview = $(html);\n            article.after(preview);\n            // Templates.runTemplateJS(js);\n            return preview;\n\n        }).then(function(preview) {\n            preview.modal('show');\n            preview.find('[data-widget=\"close\"]').on('click', function(e) {\n                e.preventDefault();\n                preview.modal('hide');\n            });\n\n            if (rawinfo.screenshots.length > 0) {\n                // Preload all remaining screenshots and make it so that the user can cycle through them\n                var screenshoturls = [rawinfo.mainscreenshot.bigthumb];\n                var screenshotindex = 0;\n                rawinfo.screenshots.forEach(function (s) {\n                    screenshoturls.push(s.bigthumb);\n                    $('<img/>')[0].src = s.bigthumb;\n                });\n                preview.find('[data-region=\"preview-screenshot\"]').on('click', function (e) {\n                    e.preventDefault();\n                    var img = $(e.currentTarget);\n                    screenshotindex++;\n                    if (screenshotindex >= screenshoturls.length) {\n                        screenshotindex = 0;\n                    }\n                    img.attr('src', screenshoturls[screenshotindex]);\n                });\n            }\n\n            $(window).on('keyup', function(e) {\n                if (e.keyCode === 27) {\n                    preview.modal('hide');\n                }\n            });\n\n            $(window).on('click', function(e) {\n                if (e.target == preview[0]) {\n                    e.preventDefault();\n                    preview.modal('hide');\n                }\n            });\n        });\n    };\n\n    /**\n     * Perform a search for plugins and display results.\n     *\n     * @method\n     * @param {String} query\n     * @return {Deferred}\n     */\n    BrowserGrid.prototype.search = function (query) {\n        var self = this;\n\n        query = query.trim();\n\n        if (self.grid.attr('data-query') === query) {\n            return $.Deferred().resolve();\n        }\n\n        return Ajax.call([{\n            methodname: 'local_plugins_get_plugins_batch',\n            args: {\n                query: query,\n                batch: 0\n            }\n\n        }])[0].fail(function(reason) {\n            Log.error('Unable to get plugins batch: ' + reason);\n\n        }).then(function(response) {\n            self.grid.attr('data-query', response.grid.query);\n            history.pushState({query: response.grid.query}, '', '/plugins/?q=' + response.grid.query);\n            return self.replace(response);\n        });\n    };\n\n    /**\n     * Display the \"Show more\" button if it seems like there might be more plugins.\n     *\n     * @method\n     */\n    BrowserGrid.prototype.displayShowMoreWidget = function () {\n        var self = this;\n\n        var batchsize = parseInt(self.grid.attr('data-batchsize'));\n\n        if (self.grid.find('[data-widget=\"plugincard\"]').length < batchsize) {\n            return;\n        }\n\n        self.showMoreWidget = $('<a href=\"\" class=\"btn btn-primary btn-lg\">' +\n            '<i class=\"fa fa-forward\" aria-hidden=\"true\"></i> Show more </a>');\n        self.showMoreWidget.on('click', function (e) {\n            e.preventDefault();\n            self.showMore();\n        });\n\n        self.grid.find('[data-region=\"loadmore\"]').html(self.showMoreWidget);\n    };\n\n    /**\n     * Repeat the same search, load and display next batch of results.\n     *\n     * @method\n     * @return {Deferred}\n     */\n    BrowserGrid.prototype.showMore = function () {\n        var self = this;\n\n        var query = self.grid.attr('data-query');\n        var nextbatch = parseInt(self.grid.attr('data-batch')) + 1;\n\n        Log.debug(query);\n        Log.debug(nextbatch);\n\n        return Ajax.call([{\n            methodname: 'local_plugins_get_plugins_batch',\n            args: {\n                query: query,\n                batch: nextbatch\n            }\n\n        }])[0].fail(function(reason) {\n            Log.error('Unable to get plugins batch: ' + reason);\n\n        }).then(function(response) {\n            return self.append(response);\n        });\n    };\n\n    /**\n     * Replace the contents with a new batch\n     *\n     * @method\n     * @param {Object} response returned by the local_plugins_get_plugins_batch function\n     * @return {Deferred}\n     */\n    BrowserGrid.prototype.replace = function (response) {\n        var self = this;\n\n        self.processResponse(response);\n\n        return Templates.render('local_plugins/browser_grid', response.grid).fail(function(reason) {\n            Log.error('Unable to render returned response:' + reason);\n\n        }).then(function(html) {\n            self.grid.html(html);\n            self.displayShowMoreWidget();\n            return response;\n\n        }).then(function() {\n            return imgSrcLazyLoad(self.grid, 'data-lazyload');\n\n        });\n    };\n\n    /**\n     * Append plugins into the grid\n     *\n     * @method\n     * @param {Object} response returned by the local_plugins_get_plugins_batch function\n     * @return {Deferred}\n     */\n    BrowserGrid.prototype.append = function (response) {\n        var self = this;\n\n        self.processResponse(response);\n\n        if (response.grid.plugins.length === 0) {\n            self.showMoreWidget.remove();\n            return $.Deferred().resolve();\n        }\n\n        return Templates.render('local_plugins/browser_grid_batch', response.grid).fail(function(reason) {\n            Log.error('Unable to render returned response:' + reason);\n\n        }).then(function(html) {\n            self.grid.find('[data-region=\"loadmore\"]').before(html);\n            return response;\n\n        }).then(function() {\n            return imgSrcLazyLoad(self.grid, 'data-lazyload');\n\n        });\n    };\n\n    /**\n     * Common operations with the received AJAX response.\n     *\n     * @method\n     */\n    BrowserGrid.prototype.processResponse = function (response) {\n        var self = this;\n\n        self.grid.attr('data-batch', response.grid.batch);\n        self.grid.attr('data-batchsize', response.grid.batchsize);\n\n        response.grid.plugins.forEach(function (data) {\n            data.rawinfo = JSON.stringify(data);\n        });\n    };\n\n    /**\n     * Lazy load images into the given placeholders.\n     *\n     * @private\n     * @param {jQuery} root Root element to search for placeholders in\n     * @param {String} sourceHolder The name of the attribute that holds the image source to be lazy loaded.\n     * @returns {Deferred}\n     */\n    function imgSrcLazyLoad(root, sourceHolder) {\n\n        var promise = $.Deferred();\n        var imgs = root.find('[' + sourceHolder + ']');\n\n        if (imgs.length) {\n            // Load all images asynchronously and then call back (resolve the promise).\n            imgs.each(/** @this HTMLElement */ function () {\n                var img = $(this);\n                var src = img.attr(sourceHolder);\n                if (src) {\n                    img.attr('src', src);\n                }\n                img.removeAttr(sourceHolder);\n                if (root.find('[' + sourceHolder + ']').length === 0) {\n                    img.on('load', promise.resolve);\n                }\n            });\n\n        } else {\n            promise.resolve();\n        }\n\n        return promise;\n    }\n\n    return {\n        /**\n         * Factory method returning a new grid instance.\n         *\n         * @param {jQuery} region\n         */\n        init: function (region) {\n            return new BrowserGrid(region);\n        }\n    };\n});\n"],"file":"browser-grid.min.js"}