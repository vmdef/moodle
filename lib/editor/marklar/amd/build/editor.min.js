define ("editor_marklar/editor",["jquery","core/yui","core/str","core/log","core/ajax","core/event","editor_marklar/filepicker","editor_marklar/imagepaster"],function(a,b,c,d,e,f,g,h){"use strict";function i(a,b){this.initparams=b;if("undefined"!=typeof M.editor_marklar.fpoptions[b.elementid]){this.initparams.filepickeroptions=M.editor_marklar.fpoptions[b.elementid]}this.initTextArea(a);this.initFormatSelector();this.initPanel();this.initFilesEmbedding();this.initPreview();this.initSyntaxHelp();this.initImagePaster()}i.prototype.initTextArea=function(a){var b=this;b.textarea=a.addClass("marklar-textarea").css("box-sizing","border-box").css("width","100%").css("background-color","white").css("margin-bottom","10px").css("padding","7px")};i.prototype.initFormatSelector=function(){var b=this,e=b.textarea.attr("name").replace("[text]","[format]"),f=b.textarea.closest("form");if(e===b.textarea.attr("name")){return}b.formatSelector=f.find("select[name=\""+e+"\"]");if(b.formatSelector.length){}else{var g=f.find("input[name=\""+e+"\"]"),h,i;if(g.length){h=parseInt(g.attr("value"))}else{d.error("marklar: format field not found: "+e);return}switch(h){case 0:i="formattext";break;case 1:i="formathtml";break;case 2:i="formatplain";break;case 4:i="formatmarkdown";break;default:d.error("marklar: unknown text format "+h);b.formatSelector=null;return;}b.formatSelector=a("<select class=\"custom-select\" name=\""+e+"\"></select>").append(a("<option value=\""+h+"\">"+i+"</option>"));g.remove();c.get_string(i,"core_moodle").done(function(a){b.formatSelector.find("option[value=\""+h+"\"]").text(a)}).fail(function(a){d.error(a)})}};i.prototype.initPanel=function(){var b=this;b.textarea.wrap("<div class=\"marklar-wrapper\"></div>");b.panel=a("<div class=\"marklar-panel\"></div>").insertAfter(b.textarea);b.editpanel=a("<div class=\"marklar-edit-panel\"></div>").appendTo(b.panel);if(b.formatSelector){b.editpanel.append(b.formatSelector);b.formatSelector.attr("data-marklar-widget","format-select")}b.panel.prepend("<span data-marklar-placeholder=\"preview\" />");b.editpanel.append("<span data-marklar-placeholder=\"syntax\" />");b.editpanel.append("<span data-marklar-placeholder=\"insert-image\" />");b.editpanel.append("<span data-marklar-placeholder=\"insert-file\" />")};i.prototype.initFilesEmbedding=function(){if(!("filepickeroptions"in this.initparams)){d.error(this.initparams.elementid+": File picker options not found");return}var f=this;b.use("core_filepicker",function(){f.filepicker=g.init(f.initparams.filepickeroptions);if(f.filepicker.canShowFilepicker("image")){c.get_string("insertimage","editor_marklar").done(function(b){var c=a("<button class=\"btn btn-default\" data-marklar-widget=\"insert-image\" />");c.text(b);c.click(function(a){a.preventDefault();f.filepicker.showFilepicker("image",function(a){f.imageEmbedded(a)})});f.panel.find("[data-marklar-placeholder=\"insert-image\"]").replaceWith(c);f.insertImageButton=c})}if(f.filepicker.canShowFilepicker("link")){c.get_string("insertlink","editor_marklar").done(function(b){var c=a("<button class=\"btn btn-default\" data-marklar-widget=\"insert-file\" />");c.text(b);c.click(function(a){a.preventDefault();f.filepicker.showFilepicker("link",function(a){f.insertLink(a)})});f.panel.find("[data-marklar-placeholder=\"insert-file\"]").replaceWith(c);f.insertFileButton=c})}})};i.prototype.initPreview=function(){var b=this;if(!b.formatSelector){return!1}b.previewBody=a("<div class=\"marklar-preview\" />").hide();b.panel.before(b.previewBody);return c.get_strings([{key:"previewon",component:"editor_marklar"},{key:"previewoff",component:"editor_marklar"}]).then(function(c){b.previewButtonOn=a("<button class=\"btn btn-default\" data-marklar-widget=\"preview-on\" />").text(c[0]).on("click",b.previewOn.bind(b));b.previewButtonOff=a("<button class=\"btn btn-default\" data-marklar-widget=\"preview-off\" >").text(c[1]).on("click",b.previewOff.bind(b)).hide();var d=a("<div class=\"marklar-preview-controls\" />").append(b.previewButtonOn).append(b.previewButtonOff);b.panel.find("[data-marklar-placeholder=\"preview\"]").replaceWith(d);return!0})};i.prototype.previewOn=function(a){var b=this;a.preventDefault();return c.get_string("previewloading","editor_marklar").then(function(a){b.previewButtonOn.hide();b.previewButtonOff.show();b.editpanel.hide();b.previewBody.html("<div class=\"marklar-preview-loading\">"+a+"</div>");b.previewBody.height(b.textarea.height());b.textarea.hide();b.previewBody.show();b.previewLoad();return!0})};i.prototype.previewOff=function(a){var b=this;a.preventDefault();b.previewButtonOff.hide();b.previewButtonOn.show();b.editpanel.show();b.previewBody.hide();b.previewBody.html("");b.textarea.show()};i.prototype.previewLoad=function(){var a=this,b={text:a.textarea.val(),format:a.formatSelector.val(),contextid:a.initparams.contextid};return e.call([{methodname:"editor_marklar_get_preview",args:b}])[0].fail(function(b){a.previewBody.html("<div class=\"alert alert-error\"><b>Error:</b> "+b.message+"</div>");d.error(b);return!1}).then(function(b){a.previewBody.html(b.html);f.notifyFilterContentUpdated(a.previewBody);return!0})};i.prototype.imageEmbedded=function(a){if("url"in a){this.insertText("<img alt=\"\" class=\"img-responsive\" src=\""+a.url+"\"/>")}};i.prototype.insertLink=function(a){if("url"in a){var b;if("file"in a&&a.file){b=a.file.replace(/(\[|\])/g,"_")}else{b="texttoshow"}this.insertText("["+b+"]("+a.url+")")}};i.prototype.insertText=function(a){var b=this.textarea.val(),c=this.textarea.prop("selectionStart"),d=this.textarea.prop("selectionEnd");this.textarea.val(b.substring(0,c)+a+b.substring(d))};i.prototype.initSyntaxHelp=function(){var b=this;if(!b.formatSelector){return!1}b.syntaxBody=a("<div class=\"marklar-syntax-help\" />").hide();b.editpanel.append(b.syntaxBody);c.get_strings([{key:"syntaxon",component:"editor_marklar"},{key:"syntaxoff",component:"editor_marklar"}]).then(function(c){b.syntaxButtonOn=a("<button class=\"btn btn-link\" data-marklar-widget=\"syntax-on\" />").text(c[0]).on("click",b.syntaxOn.bind(b));b.syntaxButtonOff=a("<button class=\"btn btn-link\" data-marklar-widget=\"syntax-off\" />").text(c[1]).on("click",b.syntaxOff.bind(b)).hide();var d=a("<div class=\"marklar-syntax-controls\" />").append(b.syntaxButtonOn).append(b.syntaxButtonOff);b.panel.find("[data-marklar-placeholder=\"syntax\"]").replaceWith(d);return!0}).catch(function(a){d.error(a);return!1});if(b.formatSelector){b.formatSelector.on("change",function(){if(b.syntaxBody.is(":visible")){b.syntaxButtonOn.click()}})}return!0};i.prototype.initImagePaster=function(){var a=this;if(!a.initparams.filepickeroptions.image){return}h.init(a.textarea,a.initparams.filepickeroptions.image,a.imageEmbedded.bind(this))};i.prototype.syntaxOn=function(a){var b=this;a.preventDefault();return c.get_string("syntaxloading","editor_marklar").then(function(a){b.syntaxButtonOn.hide();b.syntaxButtonOff.show();b.syntaxBody.html("<div class=\"marklar-syntax-loading\">"+a+"</div>");b.syntaxBody.show();b.syntaxLoad();return!0})};i.prototype.syntaxOff=function(a){var b=this;a.preventDefault();b.syntaxButtonOff.hide();b.syntaxButtonOn.show();b.syntaxBody.hide();b.syntaxBody.html("")};i.prototype.syntaxLoad=function(){var a=this;return c.get_string("syntax-format"+a.formatSelector.val(),"editor_marklar").then(function(b){a.syntaxBody.html(b)})};return{init:function init(b){var c;if("elementid"in b){c=a(document.getElementById(b.elementid))}else{throw new Error("editor_marklar: Invalid editor init parameter - missing elementid")}if(c.length){return new i(c,b)}else{throw new Error("Unable to find textarea element",b.elementid)}}}});
//# sourceMappingURL=editor.min.js.map
